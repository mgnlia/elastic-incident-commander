name: CI

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v3
      - name: Validate Python syntax (setup scripts)
        run: uv run --python 3.11 python -m compileall setup
      - name: Validate JSON definitions
        run: |
          uv run --python 3.11 python - <<'PY'
          import json
          from pathlib import Path

          checked = 0
          for folder in ("agents", "tools"):
              base = Path(folder)
              if not base.exists():
                  continue
              for file in base.rglob("*.json"):
                  json.loads(file.read_text(encoding="utf-8"))
                  checked += 1

          print(f"Validated {checked} JSON definition files")
          PY
      - name: Validate agent tool bindings
        run: |
          uv run --python 3.11 python - <<'PY'
          import json
          import sys
          from pathlib import Path

          esql_tools = {
              json.loads(path.read_text(encoding="utf-8"))["name"]
              for path in Path("tools/esql").glob("*.json")
          }
          index_tools = {"logs_search", "apm_search"}
          workflow_tools = {f"{path.stem}_workflow" for path in Path("workflows").glob("*.yaml")}

          known_tools = esql_tools | index_tools | workflow_tools
          errors = []

          for agent_file in sorted(Path("agents").glob("*.json")):
              agent = json.loads(agent_file.read_text(encoding="utf-8"))
              for tool_name in agent.get("tools", []):
                  if tool_name not in known_tools:
                      errors.append(
                          f"{agent_file}: unknown tool '{tool_name}' (not in tool/workflow definitions)"
                      )

          if errors:
              print("Tool binding validation failed:")
              for err in errors:
                  print(f"- {err}")
              sys.exit(1)

          print(
              f"Validated tool bindings for {len(list(Path('agents').glob('*.json')))} agents "
              f"against {len(known_tools)} registered tools"
          )
          PY